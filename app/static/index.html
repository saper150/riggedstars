<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>


<body>
    <p id="state"></p>
    <div>
        <label for="userId">userId</label>
        <input type="text" id="userId">
        <button onclick="connect()">connect</button>
        <button onclick="disconnect()">disconnect</button>
    </div>
    <ul id="userList"></ul>
    <div>
        <label for="roomId">roomId</label>
        <input type="text" id="roomId">
        <button onclick="joinRoom()">joinRoom</button>
        <button onclick="leaveRoom()">leaveRoom</button>
    </div>

    <p>message room</p>
    <textarea id="roomMessage"></textarea>
    <button onclick="sendMessageToRoom()">send message to room</button>

</body>

</html>

<script>

    const state = {
        set state(s) {
            this._state = s
            document.getElementById('state').innerHTML = s
        },
        get state(){
            return this._state
        }
    }

    state.state = 'disconnected'

    let socket
    let userList = []
    function connect() {
        socket = new WebSocket("ws://" + location.host + `/game?user=${document.getElementById('userId').value}`);
        socket.onopen = () => { state.state = "hub" }
        socket.onerror = console.log
        socket.onmessage = message => { handleMessage(JSON.parse(message.data)) }
        socket.onclose = () => { state.state = "disconnected" }
    }

    function disconnect() {
        socket.close()
        userList = [];
        renderUsers()
    }

    function handleMessage(message) {
        if (message.Type === "newUser") {
            userList.push(message.Payload)
            renderUsers()
        } else if (message.Type === "deleteUser") {
            userList = userList.filter(user => user.ID != message.Payload.ID)
            renderUsers()
        } else {
            console.log('unknows message type', message)
        }
    }

    function renderUsers() {
        document.getElementById('userList').innerHTML = userList.map(user => `<li>${user.ID} ${user.Name}</li>`).join('')
    }

    function joinRoom() {
        const id = Number(document.getElementById('roomId').value)
        socket.send(JSON.stringify({
            Type: 'joinRoom',
            Payload: id
        }))
        state.state = "room id=" + id
        state.roomId = id
    }

    function sendMessageToRoom() {
        socket.send(JSON.stringify({
            Type: 'text',
            Payload: document.getElementById('roomMessage').value
        }))
    }

    function leaveRoom(){
        socket.send(JSON.stringify({
            Type: 'leaveRoom'
        }))
        state.state = "hub"
    }

</script>